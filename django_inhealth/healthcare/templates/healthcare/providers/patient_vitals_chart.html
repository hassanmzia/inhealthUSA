{% extends 'healthcare/base.html' %}

{% block title %}Patient Vital Signs Charts - InHealth EHR{% endblock %}

{% block content %}
<div class="breadcrumbs">
    <a href="{% url 'index' %}">Home</a> &rsaquo;
    <a href="{% url 'provider_dashboard' %}">Provider Dashboard</a> &rsaquo;
    <a href="{% url 'patient_detail' patient.patient_id %}">{{ patient.full_name }}</a> &rsaquo;
    Vital Signs Charts
</div>

<div class="module">
    <h1>ðŸ“Š Vital Signs Charts & Trends</h1>
    <p style="color: #666; margin-top: 10px;">
        <strong>Patient:</strong> {{ patient.full_name }} (DOB: {{ patient.date_of_birth|date:"m/d/Y" }})<br>
        <strong>Doctor:</strong> Dr. {{ provider.full_name }}
    </p>

    <!-- Date Range Filter -->
    <div style="margin: 20px 0; padding: 15px; background: #f9f9f9; border-radius: 5px;">
        <strong style="margin-right: 15px;">Select Time Range:</strong>
        <a href="?days=7" class="button" style="padding: 8px 15px; margin: 0 5px; background: {% if days == 7 %}#2196F3{% else %}#ccc{% endif %}; color: white; text-decoration: none; border-radius: 3px;">7 Days</a>
        <a href="?days=14" class="button" style="padding: 8px 15px; margin: 0 5px; background: {% if days == 14 %}#2196F3{% else %}#ccc{% endif %}; color: white; text-decoration: none; border-radius: 3px;">14 Days</a>
        <a href="?days=30" class="button" style="padding: 8px 15px; margin: 0 5px; background: {% if days == 30 %}#2196F3{% else %}#ccc{% endif %}; color: white; text-decoration: none; border-radius: 3px;">30 Days</a>
        <a href="?days=90" class="button" style="padding: 8px 15px; margin: 0 5px; background: {% if days == 90 %}#2196F3{% else %}#ccc{% endif %}; color: white; text-decoration: none; border-radius: 3px;">90 Days</a>
        <a href="?days=180" class="button" style="padding: 8px 15px; margin: 0 5px; background: {% if days == 180 %}#2196F3{% else %}#ccc{% endif %}; color: white; text-decoration: none; border-radius: 3px;">6 Months</a>
        <a href="?days=365" class="button" style="padding: 8px 15px; margin: 0 5px; background: {% if days == 365 %}#2196F3{% else %}#ccc{% endif %}; color: white; text-decoration: none; border-radius: 3px;">1 Year</a>
    </div>

    <!-- Statistics -->
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin: 20px 0;">
        <div style="padding: 15px; background: #e7f3ff; border-left: 4px solid #2196F3; border-radius: 5px;">
            <div style="font-size: 11px; color: #666; margin-bottom: 5px;">Total Readings</div>
            <div style="font-size: 28px; font-weight: bold; color: #2196F3;">{{ total_readings }}</div>
        </div>
        <div style="padding: 15px; background: #ffebee; border-left: 4px solid #f44336; border-radius: 5px;">
            <div style="font-size: 11px; color: #666; margin-bottom: 5px;">Critical Readings ({{ days }} days)</div>
            <div style="font-size: 28px; font-weight: bold; color: #f44336;">{{ critical_readings }}</div>
        </div>
        {% if latest_vital %}
        <div style="padding: 15px; background: #e8f5e9; border-left: 4px solid #4caf50; border-radius: 5px;">
            <div style="font-size: 11px; color: #666; margin-bottom: 5px;">Latest Reading</div>
            <div style="font-size: 16px; font-weight: bold; color: #4caf50;">{{ latest_vital.recorded_at|date:"m/d/Y H:i" }}</div>
        </div>
        {% endif %}
    </div>

    <!-- Color Legend -->
    <div style="margin: 20px 0; padding: 15px; background: #f9f9f9; border-radius: 5px;">
        <div style="font-size: 12px; font-weight: bold; margin-bottom: 10px;">Chart Color Legend:</div>
        <div style="display: flex; flex-wrap: wrap; gap: 15px; font-size: 11px;">
            <div style="display: flex; align-items: center; gap: 5px;">
                <div style="width: 15px; height: 15px; background: rgba(76, 175, 80, 0.8); border-radius: 3px;"></div>
                <span>Green = Normal</span>
            </div>
            <div style="display: flex; align-items: center; gap: 5px;">
                <div style="width: 15px; height: 15px; background: rgba(255, 152, 0, 0.8); border-radius: 3px;"></div>
                <span>Orange = Contact Nurse</span>
            </div>
            <div style="display: flex; align-items: center; gap: 5px;">
                <div style="width: 15px; height: 15px; background: rgba(244, 67, 54, 0.8); border-radius: 3px;"></div>
                <span>Red = Contact Doctor</span>
            </div>
            <div style="display: flex; align-items: center; gap: 5px;">
                <div style="width: 15px; height: 15px; background: rgba(33, 150, 243, 0.8); border-radius: 3px;"></div>
                <span>Blue = Emergency</span>
            </div>
        </div>
    </div>

    <!-- Charts Grid -->
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(500px, 1fr)); gap: 20px; margin: 30px 0;">

        <!-- Heart Rate Chart -->
        <div style="padding: 20px; background: white; border: 1px solid #e0e0e0; border-radius: 5px;">
            <h3 style="margin: 0 0 15px 0; color: #333;">Heart Rate (bpm)</h3>
            <canvas id="heartRateChart" style="max-height: 300px;"></canvas>
        </div>

        <!-- Blood Pressure Chart -->
        <div style="padding: 20px; background: white; border: 1px solid #e0e0e0; border-radius: 5px;">
            <h3 style="margin: 0 0 15px 0; color: #333;">Blood Pressure (mmHg)</h3>
            <canvas id="bloodPressureChart" style="max-height: 300px;"></canvas>
        </div>

        <!-- Temperature Chart -->
        <div style="padding: 20px; background: white; border: 1px solid #e0e0e0; border-radius: 5px;">
            <h3 style="margin: 0 0 15px 0; color: #333;">Temperature (Â°F)</h3>
            <canvas id="temperatureChart" style="max-height: 300px;"></canvas>
        </div>

        <!-- Respiratory Rate Chart -->
        <div style="padding: 20px; background: white; border: 1px solid #e0e0e0; border-radius: 5px;">
            <h3 style="margin: 0 0 15px 0; color: #333;">Respiratory Rate (breaths/min)</h3>
            <canvas id="respiratoryRateChart" style="max-height: 300px;"></canvas>
        </div>

        <!-- Oxygen Saturation Chart -->
        <div style="padding: 20px; background: white; border: 1px solid #e0e0e0; border-radius: 5px;">
            <h3 style="margin: 0 0 15px 0; color: #333;">Oxygen Saturation (%)</h3>
            <canvas id="oxygenSaturationChart" style="max-height: 300px;"></canvas>
        </div>

        <!-- Glucose Chart -->
        <div style="padding: 20px; background: white; border: 1px solid #e0e0e0; border-radius: 5px;">
            <h3 style="margin: 0 0 15px 0; color: #333;">Glucose (mg/dL)</h3>
            <canvas id="glucoseChart" style="max-height: 300px;"></canvas>
        </div>
    </div>

    <!-- Historical Data Table -->
    <div style="margin-top: 40px;">
        <h2>Historical Vital Signs Data</h2>
        <div style="overflow-x: auto;">
            <table style="width: 100%; margin-top: 20px; border-collapse: collapse;">
                <thead>
                    <tr style="background: #f0f0f0;">
                        <th style="padding: 12px; text-align: left; border-bottom: 2px solid #ddd;">Date/Time</th>
                        <th style="padding: 12px; text-align: center; border-bottom: 2px solid #ddd;">Heart Rate</th>
                        <th style="padding: 12px; text-align: center; border-bottom: 2px solid #ddd;">BP</th>
                        <th style="padding: 12px; text-align: center; border-bottom: 2px solid #ddd;">Temp (Â°F)</th>
                        <th style="padding: 12px; text-align: center; border-bottom: 2px solid #ddd;">Resp Rate</th>
                        <th style="padding: 12px; text-align: center; border-bottom: 2px solid #ddd;">O2 Sat</th>
                        <th style="padding: 12px; text-align: center; border-bottom: 2px solid #ddd;">Glucose</th>
                        <th style="padding: 12px; text-align: center; border-bottom: 2px solid #ddd;">Alert</th>
                    </tr>
                </thead>
                <tbody>
                    {% for vital in all_vitals %}
                    <tr style="border-bottom: 1px solid #e8e8e8; {% if vital.has_critical_values %}background: #fff5f5;{% endif %}">
                        <td style="padding: 12px;">
                            <div style="font-size: 12px;">{{ vital.recorded_at|date:"m/d/Y" }}</div>
                            <div style="font-size: 11px; color: #666;">{{ vital.recorded_at|date:"H:i" }}</div>
                        </td>
                        <td style="padding: 12px; text-align: center;">
                            {% if vital.heart_rate %}
                                {{ vital.heart_rate }} bpm
                            {% else %}
                                <span style="color: #ccc;">-</span>
                            {% endif %}
                        </td>
                        <td style="padding: 12px; text-align: center;">
                            {% if vital.blood_pressure_systolic and vital.blood_pressure_diastolic %}
                                {{ vital.blood_pressure_systolic }}/{{ vital.blood_pressure_diastolic }}
                            {% else %}
                                <span style="color: #ccc;">-</span>
                            {% endif %}
                        </td>
                        <td style="padding: 12px; text-align: center;">
                            {% if vital.temperature_value %}
                                {% if vital.temperature_unit == 'C' %}
                                    {{ vital.temperature_value|floatformat:1 }}Â°C
                                {% else %}
                                    {{ vital.temperature_value|floatformat:1 }}Â°F
                                {% endif %}
                            {% else %}
                                <span style="color: #ccc;">-</span>
                            {% endif %}
                        </td>
                        <td style="padding: 12px; text-align: center;">
                            {% if vital.respiratory_rate %}
                                {{ vital.respiratory_rate }}
                            {% else %}
                                <span style="color: #ccc;">-</span>
                            {% endif %}
                        </td>
                        <td style="padding: 12px; text-align: center;">
                            {% if vital.oxygen_saturation %}
                                {{ vital.oxygen_saturation }}%
                            {% else %}
                                <span style="color: #ccc;">-</span>
                            {% endif %}
                        </td>
                        <td style="padding: 12px; text-align: center;">
                            {% if vital.glucose %}
                                {{ vital.glucose }}
                            {% else %}
                                <span style="color: #ccc;">-</span>
                            {% endif %}
                        </td>
                        <td style="padding: 12px; text-align: center;">
                            {% with alert_level=vital.get_highest_alert_level %}
                            {% if alert_level == 'Emergency' %}
                            <span style="padding: 5px 10px; background: #2196F3; color: white; border-radius: 3px; font-size: 11px; font-weight: bold;">
                                ðŸš¨ {{ alert_level }}
                            </span>
                            {% elif alert_level == 'Doctor' %}
                            <span style="padding: 5px 10px; background: #f44336; color: white; border-radius: 3px; font-size: 11px; font-weight: bold;">
                                ðŸ“ž {{ alert_level }}
                            </span>
                            {% elif alert_level == 'Nurse' %}
                            <span style="padding: 5px 10px; background: #ff9800; color: white; border-radius: 3px; font-size: 11px; font-weight: bold;">
                                ðŸ“‹ {{ alert_level }}
                            </span>
                            {% else %}
                            <span style="padding: 5px 10px; background: #4caf50; color: white; border-radius: 3px; font-size: 11px;">
                                âœ“ Normal
                            </span>
                            {% endif %}
                            {% endwith %}
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="8" style="padding: 40px; text-align: center; color: #999;">
                            No vital signs recorded yet
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <!-- Actions -->
    <div style="margin-top: 30px;">
        <a href="{% url 'patient_detail' patient.patient_id %}" class="button" style="padding: 12px 30px; background: #2196F3; color: white; text-decoration: none; border-radius: 5px; display: inline-block;">
            Back to Patient Detail
        </a>
        <a href="{% url 'provider_dashboard' %}" class="button" style="padding: 12px 30px; background: #666; color: white; text-decoration: none; border-radius: 5px; display: inline-block; margin-left: 10px;">
            Back to Dashboard
        </a>
    </div>
</div>

<!-- Chart.js Library -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

<script>
// Parse chart data from Django
const chartData = {{ chart_data_json|safe }};

// Common chart options
const commonOptions = {
    responsive: true,
    maintainAspectRatio: true,
    plugins: {
        legend: {
            display: true,
            position: 'top'
        }
    },
    scales: {
        x: {
            display: true,
            title: {
                display: true,
                text: 'Date/Time'
            }
        },
        y: {
            display: true,
            beginAtZero: false
        }
    }
};

// Heart Rate Chart
const heartRateCtx = document.getElementById('heartRateChart').getContext('2d');
new Chart(heartRateCtx, {
    type: 'line',
    data: {
        labels: chartData.dates,
        datasets: [{
            label: 'Heart Rate (bpm)',
            data: chartData.heart_rate,
            borderColor: 'rgba(244, 67, 54, 0.8)',
            backgroundColor: 'rgba(244, 67, 54, 0.1)',
            pointBackgroundColor: chartData.heart_rate_colors,
            pointBorderColor: chartData.heart_rate_colors,
            pointRadius: 5,
            pointHoverRadius: 7,
            tension: 0.3,
            fill: true
        }]
    },
    options: {
        ...commonOptions,
        scales: {
            ...commonOptions.scales,
            y: {
                ...commonOptions.scales.y,
                title: {
                    display: true,
                    text: 'BPM'
                },
                min: 30,
                max: 160
            }
        }
    }
});

// Blood Pressure Chart
const bloodPressureCtx = document.getElementById('bloodPressureChart').getContext('2d');
new Chart(bloodPressureCtx, {
    type: 'line',
    data: {
        labels: chartData.dates,
        datasets: [
            {
                label: 'Systolic (SBP)',
                data: chartData.sbp,
                borderColor: 'rgba(244, 67, 54, 0.8)',
                backgroundColor: 'rgba(244, 67, 54, 0.1)',
                pointBackgroundColor: chartData.sbp_colors,
                pointBorderColor: chartData.sbp_colors,
                pointRadius: 5,
                pointHoverRadius: 7,
                tension: 0.3,
                fill: false
            },
            {
                label: 'Diastolic (DBP)',
                data: chartData.dbp,
                borderColor: 'rgba(33, 150, 243, 0.8)',
                backgroundColor: 'rgba(33, 150, 243, 0.1)',
                pointBackgroundColor: chartData.dbp_colors,
                pointBorderColor: chartData.dbp_colors,
                pointRadius: 5,
                pointHoverRadius: 7,
                tension: 0.3,
                fill: false
            }
        ]
    },
    options: {
        ...commonOptions,
        scales: {
            ...commonOptions.scales,
            y: {
                ...commonOptions.scales.y,
                title: {
                    display: true,
                    text: 'mmHg'
                },
                min: 40,
                max: 200
            }
        }
    }
});

// Temperature Chart
const temperatureCtx = document.getElementById('temperatureChart').getContext('2d');
new Chart(temperatureCtx, {
    type: 'line',
    data: {
        labels: chartData.dates,
        datasets: [{
            label: 'Temperature (Â°F)',
            data: chartData.temperature,
            borderColor: 'rgba(255, 152, 0, 0.8)',
            backgroundColor: 'rgba(255, 152, 0, 0.1)',
            pointBackgroundColor: chartData.temperature_colors,
            pointBorderColor: chartData.temperature_colors,
            pointRadius: 5,
            pointHoverRadius: 7,
            tension: 0.3,
            fill: true
        }]
    },
    options: {
        ...commonOptions,
        scales: {
            ...commonOptions.scales,
            y: {
                ...commonOptions.scales.y,
                title: {
                    display: true,
                    text: 'Â°F'
                },
                min: 95,
                max: 106
            }
        }
    }
});

// Respiratory Rate Chart
const respiratoryRateCtx = document.getElementById('respiratoryRateChart').getContext('2d');
new Chart(respiratoryRateCtx, {
    type: 'line',
    data: {
        labels: chartData.dates,
        datasets: [{
            label: 'Respiratory Rate (breaths/min)',
            data: chartData.respiratory_rate,
            borderColor: 'rgba(156, 39, 176, 0.8)',
            backgroundColor: 'rgba(156, 39, 176, 0.1)',
            pointBackgroundColor: chartData.respiratory_rate_colors,
            pointBorderColor: chartData.respiratory_rate_colors,
            pointRadius: 5,
            pointHoverRadius: 7,
            tension: 0.3,
            fill: true
        }]
    },
    options: {
        ...commonOptions,
        scales: {
            ...commonOptions.scales,
            y: {
                ...commonOptions.scales.y,
                title: {
                    display: true,
                    text: 'Breaths/min'
                },
                min: 8,
                max: 30
            }
        }
    }
});

// Oxygen Saturation Chart
const oxygenSaturationCtx = document.getElementById('oxygenSaturationChart').getContext('2d');
new Chart(oxygenSaturationCtx, {
    type: 'line',
    data: {
        labels: chartData.dates,
        datasets: [{
            label: 'Oxygen Saturation (%)',
            data: chartData.oxygen_saturation,
            borderColor: 'rgba(33, 150, 243, 0.8)',
            backgroundColor: 'rgba(33, 150, 243, 0.1)',
            pointBackgroundColor: chartData.oxygen_saturation_colors,
            pointBorderColor: chartData.oxygen_saturation_colors,
            pointRadius: 5,
            pointHoverRadius: 7,
            tension: 0.3,
            fill: true
        }]
    },
    options: {
        ...commonOptions,
        scales: {
            ...commonOptions.scales,
            y: {
                ...commonOptions.scales.y,
                title: {
                    display: true,
                    text: '%'
                },
                min: 85,
                max: 100
            }
        }
    }
});

// Glucose Chart
const glucoseCtx = document.getElementById('glucoseChart').getContext('2d');
new Chart(glucoseCtx, {
    type: 'line',
    data: {
        labels: chartData.dates,
        datasets: [{
            label: 'Glucose (mg/dL)',
            data: chartData.glucose,
            borderColor: 'rgba(76, 175, 80, 0.8)',
            backgroundColor: 'rgba(76, 175, 80, 0.1)',
            pointBackgroundColor: chartData.glucose_colors,
            pointBorderColor: chartData.glucose_colors,
            pointRadius: 5,
            pointHoverRadius: 7,
            tension: 0.3,
            fill: true
        }]
    },
    options: {
        ...commonOptions,
        scales: {
            ...commonOptions.scales,
            y: {
                ...commonOptions.scales.y,
                title: {
                    display: true,
                    text: 'mg/dL'
                },
                min: 50,
                max: 300
            }
        }
    }
});
</script>
{% endblock %}

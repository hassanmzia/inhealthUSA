{% extends 'healthcare/base.html' %}
{% block title %}My Provider Profile - InHealth EHR{% endblock %}
{% block breadcrumbs %}My Provider Profile{% endblock %}
{% block content %}
<style>
.profile-header{background:white;border:1px solid var(--hairline-color);border-radius:4px;padding:20px;margin-bottom:20px;display:flex;justify-content:space-between;align-items:center}
.profile-header h1{margin:0;font-size:28px;font-weight:300}
.profile-header .meta{font-size:13px;color:#666;margin-top:8px}
.profile-header .actions{display:flex;gap:10px}
.stats-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:15px;margin-bottom:20px}
.stat-card{background:white;border:1px solid var(--hairline-color);border-radius:4px;padding:20px;text-align:center}
.stat-card .number{font-size:32px;font-weight:300;color:var(--primary);margin-bottom:5px}
.stat-card .label{font-size:13px;color:#666;text-transform:uppercase;letter-spacing:0.5px}
.info-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(300px,1fr));gap:20px;margin-bottom:20px}
.info-module{background:white;border:1px solid var(--hairline-color);border-radius:4px;margin-bottom:20px;overflow:hidden}
.info-module h2{margin:0;padding:12px 20px;font-weight:500;font-size:15px;background:var(--primary);color:var(--header-link-color)}
.info-module .content{padding:0}
.info-module dl{margin:0}
.info-module dl>div{display:grid;grid-template-columns:180px 1fr;gap:20px;padding:12px 20px;border-bottom:1px solid var(--hairline-color)}
.info-module dl>div:nth-child(even){background:var(--darkened-bg)}
.info-module dl>div:last-child{border-bottom:none}
.info-module dt{font-size:13px;font-weight:600;color:#666}
.info-module dd{font-size:13px;color:var(--body-fg);margin:0}
.data-table-module{background:white;border:1px solid var(--hairline-color);border-radius:4px;margin-bottom:20px;overflow:hidden}
.data-table-module h2{margin:0;padding:12px 20px;font-weight:500;font-size:15px;background:var(--primary);color:var(--header-link-color)}
.data-table-module table{width:100%;border-collapse:collapse}
.data-table-module thead{background:var(--darkened-bg)}
.data-table-module thead th{padding:10px 15px;text-align:left;font-size:11px;font-weight:600;text-transform:uppercase;color:var(--body-fg);border-bottom:1px solid var(--hairline-color)}
.data-table-module tbody td{padding:12px 15px;border-bottom:1px solid var(--hairline-color);font-size:13px}
.data-table-module tbody tr:hover{background:var(--darkened-bg)}
.data-table-module tbody tr:last-child td{border-bottom:none}
.data-table-module .empty{text-align:center;padding:40px 20px;color:#999;font-style:italic}
.status-badge{padding:4px 12px;border-radius:12px;font-size:11px;font-weight:600;text-transform:uppercase}
.status-scheduled{background:#e3f2fd;color:#1565c0}
.status-completed{background:#e8f5e9;color:#2e7d32}
.status-cancelled{background:#ffebee;color:#c62828}
.status-active{background:#e8f5e9;color:#2e7d32}
.status-pending{background:#fff3e0;color:#e65100}
.button{display:inline-block;padding:10px 20px;background:var(--primary);color:var(--header-link-color);text-decoration:none;border-radius:4px;font-size:13px;font-weight:500;border:none;cursor:pointer;transition:background 0.2s}
.button:hover{background:var(--primary-dark,#205067);color:white}
</style>

<div class="profile-header">
    <div>
        <h1>Dr. {{ provider.full_name }}</h1>
        <div class="meta">
            <strong>Specialty:</strong> {{ provider.specialty|default:"—" }} |
            <strong>NPI:</strong> {{ provider.npi }}
        </div>
    </div>
    <div class="actions">
        <a href="{% url 'provider_profile_edit' %}" class="button" style="color: white;">Edit My Profile</a>
    </div>
</div>

<div class="stats-grid">
    <div class="stat-card">
        <div class="number">{{ total_patients }}</div>
        <div class="label">Total Patients</div>
    </div>
    <div class="stat-card">
        <div class="number">{{ total_appointments }}</div>
        <div class="label">Total Appointments</div>
    </div>
    <div class="stat-card">
        <div class="number">{{ upcoming_appointments }}</div>
        <div class="label">Upcoming Appointments</div>
    </div>
</div>

<div class="info-grid">
    <div class="info-module">
        <h2>Professional Information</h2>
        <div class="content">
            <dl>
                <div><dt>Full Name</dt><dd>Dr. {{ provider.full_name }}</dd></div>
                <div><dt>Specialty</dt><dd>{{ provider.specialty|default:"—" }}</dd></div>
                <div><dt>NPI Number</dt><dd>{{ provider.npi }}</dd></div>
                <div><dt>License Number</dt><dd>{{ provider.license_number|default:"—" }}</dd></div>
                <div><dt>Status</dt><dd>{% if provider.is_active %}<span class="status-badge status-active">Active</span>{% else %}<span class="status-badge status-cancelled">Inactive</span>{% endif %}</dd></div>
            </dl>
        </div>
    </div>

    <div class="info-module">
        <h2>Contact Information</h2>
        <div class="content">
            <dl>
                <div><dt>Email</dt><dd>{{ provider.email|default:"—" }}</dd></div>
                <div><dt>Phone</dt><dd>{{ provider.phone|default:"—" }}</dd></div>
            </dl>
        </div>
    </div>
</div>

{% if provider.department or provider.hospital %}
<div class="info-module">
    <h2>Affiliation</h2>
    <div class="content">
        <dl>
            {% if provider.hospital %}
            <div><dt>Hospital</dt><dd>{{ provider.hospital.name }}</dd></div>
            {% endif %}
            {% if provider.department %}
            <div><dt>Department</dt><dd>{{ provider.department.name }}</dd></div>
            {% endif %}
        </dl>
    </div>
</div>
{% endif %}

<div class="data-table-module">
    <h2>Recent Appointments</h2>
    {% if appointments %}
    <table>
        <thead>
            <tr>
                <th>Date & Time</th>
                <th>Patient</th>
                <th>Type</th>
                <th>Status</th>
                <th>Chief Complaint</th>
            </tr>
        </thead>
        <tbody>
            {% for appointment in appointments %}
            <tr>
                <td>{{ appointment.encounter_date|date:"M d, Y H:i" }}</td>
                <td><strong>{{ appointment.patient.full_name }}</strong></td>
                <td>{{ appointment.encounter_type }}</td>
                <td><span class="status-badge status-{{ appointment.status|lower|cut:' ' }}">{{ appointment.status }}</span></td>
                <td>{{ appointment.chief_complaint|truncatewords:10|default:"—" }}</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    {% else %}
    <div class="empty">No appointments found</div>
    {% endif %}
</div>

<div class="data-table-module">
    <h2>My Patients</h2>
    {% if patients %}
    <table>
        <thead>
            <tr>
                <th>Patient ID</th>
                <th>Name</th>
                <th>Date of Birth</th>
                <th>Gender</th>
                <th>Phone</th>
                <th>Email</th>
            </tr>
        </thead>
        <tbody>
            {% for patient in patients %}
            <tr>
                <td>{{ patient.patient_id }}</td>
                <td><strong>{{ patient.full_name }}</strong></td>
                <td>{{ patient.date_of_birth|date:"M d, Y" }}</td>
                <td>{{ patient.gender }}</td>
                <td>{{ patient.phone|default:"—" }}</td>
                <td>{{ patient.email|default:"—" }}</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    {% else %}
    <div class="empty">No patients found</div>
    {% endif %}
</div>

<div class="data-table-module">
    <h2>Recent Prescriptions I've Written</h2>
    {% if prescriptions %}
    <table>
        <thead>
            <tr>
                <th>Patient</th>
                <th>Medication</th>
                <th>Dosage</th>
                <th>Frequency</th>
                <th>Start Date</th>
                <th>Status</th>
            </tr>
        </thead>
        <tbody>
            {% for prescription in prescriptions %}
            <tr>
                <td><strong>{{ prescription.patient.full_name }}</strong></td>
                <td>{{ prescription.medication_name }}</td>
                <td>{{ prescription.dosage }}</td>
                <td>{{ prescription.frequency }}</td>
                <td>{{ prescription.start_date|date:"M d, Y" }}</td>
                <td><span class="status-badge status-{{ prescription.status|lower }}">{{ prescription.status }}</span></td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    {% else %}
    <div class="empty">No prescriptions found</div>
    {% endif %}
</div>

<div class="data-table-module">
    <h2>Recent Diagnoses I've Made</h2>
    {% if diagnoses %}
    <table>
        <thead>
            <tr>
                <th>Date</th>
                <th>Patient</th>
                <th>Diagnosis</th>
                <th>ICD-10 Code</th>
                <th>Type</th>
                <th>Status</th>
            </tr>
        </thead>
        <tbody>
            {% for diagnosis in diagnoses %}
            <tr>
                <td>{{ diagnosis.diagnosed_at|date:"M d, Y" }}</td>
                <td><strong>{{ diagnosis.encounter.patient.full_name }}</strong></td>
                <td>{{ diagnosis.diagnosis_description|truncatewords:15 }}</td>
                <td>{{ diagnosis.icd10_code|default:"—" }}</td>
                <td>{{ diagnosis.diagnosis_type }}</td>
                <td><span class="status-badge status-{{ diagnosis.status|lower }}">{{ diagnosis.status }}</span></td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    {% else %}
    <div class="empty">No diagnoses found</div>
    {% endif %}
</div>

<div class="data-table-module">
    <h2>Recent Vital Signs for My Patients</h2>
    {% if vitals %}
    <table>
        <thead>
            <tr>
                <th>Date</th>
                <th>Patient</th>
                <th>Blood Pressure</th>
                <th>Heart Rate</th>
                <th>Temperature</th>
                <th>Weight</th>
            </tr>
        </thead>
        <tbody>
            {% for vital in vitals %}
            <tr>
                <td>{{ vital.recorded_at|date:"M d, Y" }}</td>
                <td><strong>{{ vital.encounter.patient.full_name }}</strong></td>
                <td>{{ vital.blood_pressure }}</td>
                <td>{% if vital.heart_rate %}{{ vital.heart_rate }} bpm{% else %}—{% endif %}</td>
                <td>{% if vital.temperature_value %}{{ vital.temperature_value }}°{{ vital.temperature_unit }}{% else %}—{% endif %}</td>
                <td>{% if vital.weight_value %}{{ vital.weight_value }} {{ vital.weight_unit }}{% else %}—{% endif %}</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    {% else %}
    <div class="empty">No vital signs found</div>
    {% endif %}
</div>

<div class="data-table-module">
    <h2>Treatment Plans</h2>
    {% if appointments %}
    <table>
        <thead>
            <tr>
                <th>Date</th>
                <th>Patient</th>
                <th>Treatment Plan</th>
                <th>Status</th>
            </tr>
        </thead>
        <tbody>
            {% for appointment in appointments %}
            {% if appointment.treatment_plan %}
            <tr>
                <td>{{ appointment.encounter_date|date:"M d, Y" }}</td>
                <td><strong>{{ appointment.patient.full_name }}</strong></td>
                <td>{{ appointment.treatment_plan|truncatewords:25 }}</td>
                <td><span class="status-badge status-{{ appointment.status|lower|cut:' ' }}">{{ appointment.status }}</span></td>
            </tr>
            {% endif %}
            {% endfor %}
        </tbody>
    </table>
    {% else %}
    <div class="empty">No treatment plans found</div>
    {% endif %}
</div>

<div class="data-table-module">
    <h2>Clinical Notes</h2>
    {% if appointments %}
    <table>
        <thead>
            <tr>
                <th>Date</th>
                <th>Patient</th>
                <th>Clinical Impression</th>
                <th>Notes</th>
            </tr>
        </thead>
        <tbody>
            {% for appointment in appointments %}
            {% if appointment.clinical_impression or appointment.notes %}
            <tr>
                <td>{{ appointment.encounter_date|date:"M d, Y" }}</td>
                <td><strong>{{ appointment.patient.full_name }}</strong></td>
                <td>{{ appointment.clinical_impression|truncatewords:20|default:"—" }}</td>
                <td>{{ appointment.notes|truncatewords:20|default:"—" }}</td>
            </tr>
            {% endif %}
            {% endfor %}
        </tbody>
    </table>
    {% else %}
    <div class="empty">No clinical notes found</div>
    {% endif %}
</div>

<div class="data-table-module">
    <h2>Patient Allergies</h2>
    {% if allergies %}
    <table>
        <thead>
            <tr>
                <th>Patient</th>
                <th>Allergen</th>
                <th>Reaction</th>
                <th>Severity</th>
                <th>Onset Date</th>
                <th>Notes</th>
            </tr>
        </thead>
        <tbody>
            {% for allergy in allergies %}
            <tr>
                <td><strong>{{ allergy.patient.full_name }}</strong></td>
                <td>{{ allergy.allergen }}</td>
                <td>{{ allergy.reaction|truncatewords:10|default:"—" }}</td>
                <td>
                    <span class="status-badge {% if allergy.severity == 'Severe' %}status-cancelled{% elif allergy.severity == 'Moderate' %}status-pending{% else %}status-active{% endif %}">
                        {{ allergy.severity }}
                    </span>
                </td>
                <td>{{ allergy.onset_date|date:"M d, Y"|default:"—" }}</td>
                <td>{{ allergy.notes|truncatewords:10|default:"—" }}</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    {% else %}
    <div class="empty">No allergies recorded for your patients</div>
    {% endif %}
</div>

<div class="data-table-module">
    <h2>Patient Medical History</h2>
    {% if medical_history %}
    <table>
        <thead>
            <tr>
                <th>Patient</th>
                <th>Condition</th>
                <th>Diagnosis Date</th>
                <th>Status</th>
                <th>Notes</th>
            </tr>
        </thead>
        <tbody>
            {% for history in medical_history %}
            <tr>
                <td><strong>{{ history.patient.full_name }}</strong></td>
                <td>{{ history.condition_name }}</td>
                <td>{{ history.diagnosis_date|date:"M d, Y" }}</td>
                <td><span class="status-badge status-{{ history.status|lower }}">{{ history.status }}</span></td>
                <td>{{ history.notes|truncatewords:15|default:"—" }}</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    {% else %}
    <div class="empty">No medical history found</div>
    {% endif %}
</div>

<div class="data-table-module">
    <h2>Patient Social History</h2>
    {% if social_history %}
    <table>
        <thead>
            <tr>
                <th>Patient</th>
                <th>Smoking Status</th>
                <th>Alcohol Use</th>
                <th>Exercise</th>
                <th>Occupation</th>
            </tr>
        </thead>
        <tbody>
            {% for history in social_history %}
            <tr>
                <td><strong>{{ history.patient.full_name }}</strong></td>
                <td>{{ history.smoking_status|default:"—" }}</td>
                <td>{{ history.alcohol_use|default:"—" }}</td>
                <td>{{ history.exercise_frequency|default:"—" }}</td>
                <td>{{ history.occupation|default:"—" }}</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    {% else %}
    <div class="empty">No social history found</div>
    {% endif %}
</div>

<div class="data-table-module">
    <h2>Patient Lab Tests & Results</h2>
    {% if lab_tests %}
    <table>
        <thead>
            <tr>
                <th>Patient</th>
                <th>Test Date</th>
                <th>Test Name</th>
                <th>Result Value</th>
                <th>Status</th>
                <th>Notes</th>
            </tr>
        </thead>
        <tbody>
            {% for test in lab_tests %}
            <tr>
                <td><strong>{{ test.patient.full_name }}</strong></td>
                <td>{{ test.test_date|date:"M d, Y" }}</td>
                <td>{{ test.test_name }}</td>
                <td>{{ test.result_value|default:"—" }}</td>
                <td><span class="status-badge status-{{ test.result_status|lower }}">{{ test.result_status }}</span></td>
                <td>{{ test.notes|truncatewords:10|default:"—" }}</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    {% else %}
    <div class="empty">No lab tests found</div>
    {% endif %}
</div>

<div class="data-table-module">
    <h2>Patient Billing Information</h2>
    {% if billings %}
    <table>
        <thead>
            <tr>
                <th>Patient</th>
                <th>Invoice #</th>
                <th>Date</th>
                <th>Total Amount</th>
                <th>Amount Paid</th>
                <th>Amount Due</th>
                <th>Status</th>
            </tr>
        </thead>
        <tbody>
            {% for bill in billings %}
            <tr>
                <td><strong>{{ bill.patient.full_name }}</strong></td>
                <td>{{ bill.invoice_number }}</td>
                <td>{{ bill.billing_date|date:"M d, Y" }}</td>
                <td>${{ bill.total_amount }}</td>
                <td>${{ bill.amount_paid }}</td>
                <td>${{ bill.amount_due }}</td>
                <td><span class="status-badge status-{{ bill.status|lower }}">{{ bill.status }}</span></td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    {% else %}
    <div class="empty">No billing records found</div>
    {% endif %}
</div>

<div class="data-table-module">
    <h2>Patient Payment History</h2>
    {% if payments %}
    <table>
        <thead>
            <tr>
                <th>Patient</th>
                <th>Date</th>
                <th>Amount</th>
                <th>Method</th>
                <th>Transaction ID</th>
                <th>Status</th>
            </tr>
        </thead>
        <tbody>
            {% for payment in payments %}
            <tr>
                <td><strong>{{ payment.patient.full_name }}</strong></td>
                <td>{{ payment.payment_date|date:"M d, Y" }}</td>
                <td>${{ payment.amount }}</td>
                <td>{{ payment.payment_method }}</td>
                <td>{{ payment.transaction_id|default:"—" }}</td>
                <td><span class="status-badge status-{{ payment.status|lower }}">{{ payment.status }}</span></td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    {% else %}
    <div class="empty">No payment history found</div>
    {% endif %}
</div>

<div class="data-table-module">
    <h2>Patient Insurance Information</h2>
    {% if insurance_info %}
    <table>
        <thead>
            <tr>
                <th>Patient</th>
                <th>Provider</th>
                <th>Policy Number</th>
                <th>Group Number</th>
                <th>Effective Date</th>
                <th>Primary</th>
            </tr>
        </thead>
        <tbody>
            {% for insurance in insurance_info %}
            <tr>
                <td><strong>{{ insurance.patient.full_name }}</strong></td>
                <td>{{ insurance.provider_name }}</td>
                <td>{{ insurance.policy_number }}</td>
                <td>{{ insurance.group_number|default:"—" }}</td>
                <td>{{ insurance.effective_date|date:"M d, Y" }}</td>
                <td>{% if insurance.is_primary %}<span class="status-badge status-active">Yes</span>{% else %}No{% endif %}</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    {% else %}
    <div class="empty">No insurance information found</div>
    {% endif %}
</div>

<div class="data-table-module">
    <h2>Patient Medical Devices</h2>
    {% if devices %}
    <table>
        <thead>
            <tr>
                <th>Patient</th>
                <th>Device Name</th>
                <th>Type</th>
                <th>Manufacturer</th>
                <th>Registration Date</th>
                <th>Status</th>
            </tr>
        </thead>
        <tbody>
            {% for device in devices %}
            <tr>
                <td><strong>{{ device.patient.full_name }}</strong></td>
                <td>{{ device.device_name }}</td>
                <td>{{ device.device_type }}</td>
                <td>{{ device.manufacturer|default:"—" }}</td>
                <td>{{ device.registration_date|date:"M d, Y" }}</td>
                <td><span class="status-badge status-{{ device.status|lower }}">{{ device.status }}</span></td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    {% else %}
    <div class="empty">No medical devices found</div>
    {% endif %}
</div>

{% endblock %}

{% extends 'healthcare/base.html' %}

{% block title %}Edit Vital Signs - InHealth EHR{% endblock %}

{% block content %}
<div class="breadcrumbs">
    <a href="{% url 'index' %}">Home</a> &rsaquo;
    <a href="{% url 'nurse_dashboard' %}">Nurse Dashboard</a> &rsaquo;
    <a href="{% url 'nurse_vitals_list' %}">Vitals List</a> &rsaquo;
    Edit Vital Signs
</div>

<div class="module">
    <h1>‚úèÔ∏è Edit Vital Signs</h1>
    <p style="color: #666; margin-top: 10px;">Nurse: {{ nurse.full_name }} | Hospital: {{ nurse.hospital.hospital_name }}</p>

    <!-- Patient Information -->
    <div style="background: #f0f8ff; border-left: 4px solid #2196F3; padding: 15px; margin: 20px 0; border-radius: 5px;">
        <div style="font-size: 14px; font-weight: bold; margin-bottom: 8px;">Patient Information</div>
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
            <div>
                <span style="font-size: 12px; color: #666;">Name:</span>
                <span style="font-size: 13px; font-weight: bold; margin-left: 8px;">{{ patient.full_name }}</span>
            </div>
            <div>
                <span style="font-size: 12px; color: #666;">DOB:</span>
                <span style="font-size: 13px; margin-left: 8px;">{{ patient.date_of_birth|date:"m/d/Y" }}</span>
            </div>
            <div>
                <span style="font-size: 12px; color: #666;">Patient ID:</span>
                <span style="font-size: 13px; margin-left: 8px;">{{ patient.patient_id }}</span>
            </div>
        </div>
    </div>

    <!-- Vital Signs Metadata -->
    <div style="background: #e8f5e9; border-left: 4px solid #4caf50; padding: 15px; margin: 20px 0; border-radius: 5px;">
        <div style="font-size: 14px; font-weight: bold; margin-bottom: 8px;">Recording Information</div>
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
            <div>
                <span style="font-size: 12px; color: #666;">Recorded At:</span>
                <span style="font-size: 13px; margin-left: 8px;">{{ vital.recorded_at|date:"m/d/Y H:i" }}</span>
            </div>
            <div>
                <span style="font-size: 12px; color: #666;">Data Source:</span>
                <span style="font-size: 13px; margin-left: 8px;">
                    {% if vital.data_source == 'device' %}
                        üì± IoT Device
                    {% else %}
                        ‚úã Manual Entry
                    {% endif %}
                </span>
            </div>
            <div>
                <span style="font-size: 12px; color: #666;">Recorded By:</span>
                <span style="font-size: 13px; margin-left: 8px;">
                    {% if vital.recorded_by_nurse %}
                        {{ vital.recorded_by_nurse.full_name }}
                    {% elif vital.recorded_by %}
                        Dr. {{ vital.recorded_by.full_name }}
                    {% else %}
                        Unknown
                    {% endif %}
                </span>
            </div>
        </div>
    </div>

    <form method="post" style="background: white; padding: 20px; border: 1px solid #ddd; border-radius: 5px;">
        {% csrf_token %}

        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px;">

            <!-- Heart Rate -->
            <div class="form-row">
                <label for="heart_rate" style="display: block; font-size: 13px; font-weight: 600; margin-bottom: 5px;">
                    ‚ù§Ô∏è Heart Rate (bpm)
                </label>
                <input type="number"
                       id="heart_rate"
                       name="heart_rate"
                       value="{{ vital.heart_rate|default:'' }}"
                       step="1"
                       min="0"
                       max="300"
                       placeholder="e.g., 72"
                       style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px;">
                <small style="display: block; margin-top: 5px; color: #666; font-size: 11px;">
                    Normal: 60-100 bpm
                </small>
            </div>

            <!-- Blood Pressure Systolic -->
            <div class="form-row">
                <label for="blood_pressure_systolic" style="display: block; font-size: 13px; font-weight: 600; margin-bottom: 5px;">
                    ü©∏ Systolic BP (mmHg)
                </label>
                <input type="number"
                       id="blood_pressure_systolic"
                       name="blood_pressure_systolic"
                       value="{{ vital.blood_pressure_systolic|default:'' }}"
                       step="1"
                       min="0"
                       max="300"
                       placeholder="e.g., 120"
                       style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px;">
                <small style="display: block; margin-top: 5px; color: #666; font-size: 11px;">
                    Normal: 90-120 mmHg
                </small>
            </div>

            <!-- Blood Pressure Diastolic -->
            <div class="form-row">
                <label for="blood_pressure_diastolic" style="display: block; font-size: 13px; font-weight: 600; margin-bottom: 5px;">
                    ü©∏ Diastolic BP (mmHg)
                </label>
                <input type="number"
                       id="blood_pressure_diastolic"
                       name="blood_pressure_diastolic"
                       value="{{ vital.blood_pressure_diastolic|default:'' }}"
                       step="1"
                       min="0"
                       max="200"
                       placeholder="e.g., 80"
                       style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px;">
                <small style="display: block; margin-top: 5px; color: #666; font-size: 11px;">
                    Normal: 60-80 mmHg
                </small>
            </div>

            <!-- Temperature -->
            <div class="form-row">
                <label for="temperature_value" style="display: block; font-size: 13px; font-weight: 600; margin-bottom: 5px;">
                    üå°Ô∏è Temperature
                </label>
                <div style="display: flex; gap: 10px;">
                    <input type="number"
                           id="temperature_value"
                           name="temperature_value"
                           value="{{ vital.temperature_value|default:'' }}"
                           step="0.1"
                           min="0"
                           max="120"
                           placeholder="98.6"
                           style="flex: 1; padding: 10px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px;">
                    <select id="temperature_unit"
                            name="temperature_unit"
                            style="padding: 10px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px;">
                        <option value="F" {% if vital.temperature_unit == 'F' %}selected{% endif %}>¬∞F</option>
                        <option value="C" {% if vital.temperature_unit == 'C' %}selected{% endif %}>¬∞C</option>
                    </select>
                </div>
                <small style="display: block; margin-top: 5px; color: #666; font-size: 11px;">
                    Normal: 97.0-99.0¬∞F (36.1-37.2¬∞C)
                </small>
            </div>

            <!-- Respiratory Rate -->
            <div class="form-row">
                <label for="respiratory_rate" style="display: block; font-size: 13px; font-weight: 600; margin-bottom: 5px;">
                    ü´Å Respiratory Rate (breaths/min)
                </label>
                <input type="number"
                       id="respiratory_rate"
                       name="respiratory_rate"
                       value="{{ vital.respiratory_rate|default:'' }}"
                       step="1"
                       min="0"
                       max="100"
                       placeholder="e.g., 16"
                       style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px;">
                <small style="display: block; margin-top: 5px; color: #666; font-size: 11px;">
                    Normal: 12-20 breaths/min
                </small>
            </div>

            <!-- Oxygen Saturation -->
            <div class="form-row">
                <label for="oxygen_saturation" style="display: block; font-size: 13px; font-weight: 600; margin-bottom: 5px;">
                    üí® Oxygen Saturation (%)
                </label>
                <input type="number"
                       id="oxygen_saturation"
                       name="oxygen_saturation"
                       value="{{ vital.oxygen_saturation|default:'' }}"
                       step="1"
                       min="0"
                       max="100"
                       placeholder="e.g., 98"
                       style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px;">
                <small style="display: block; margin-top: 5px; color: #666; font-size: 11px;">
                    Normal: 95-100%
                </small>
            </div>

            <!-- Glucose -->
            <div class="form-row">
                <label for="glucose" style="display: block; font-size: 13px; font-weight: 600; margin-bottom: 5px;">
                    ü©π Blood Glucose (mg/dL)
                </label>
                <input type="number"
                       id="glucose"
                       name="glucose"
                       value="{{ vital.glucose|default:'' }}"
                       step="1"
                       min="0"
                       max="1000"
                       placeholder="e.g., 100"
                       style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px;">
                <small style="display: block; margin-top: 5px; color: #666; font-size: 11px;">
                    Normal (fasting): 70-100 mg/dL
                </small>
            </div>

            <!-- Weight -->
            <div class="form-row">
                <label for="weight_value" style="display: block; font-size: 13px; font-weight: 600; margin-bottom: 5px;">
                    ‚öñÔ∏è Weight
                </label>
                <div style="display: flex; gap: 10px;">
                    <input type="number"
                           id="weight_value"
                           name="weight_value"
                           value="{{ vital.weight_value|default:'' }}"
                           step="0.1"
                           min="0"
                           placeholder="150"
                           style="flex: 1; padding: 10px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px;">
                    <select id="weight_unit"
                            name="weight_unit"
                            style="padding: 10px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px;">
                        <option value="lbs" {% if vital.weight_unit == 'lbs' %}selected{% endif %}>lbs</option>
                        <option value="kg" {% if vital.weight_unit == 'kg' %}selected{% endif %}>kg</option>
                    </select>
                </div>
            </div>

            <!-- Height -->
            <div class="form-row">
                <label for="height_value" style="display: block; font-size: 13px; font-weight: 600; margin-bottom: 5px;">
                    üìè Height
                </label>
                <div style="display: flex; gap: 10px;">
                    <input type="number"
                           id="height_value"
                           name="height_value"
                           value="{{ vital.height_value|default:'' }}"
                           step="0.1"
                           min="0"
                           placeholder="68"
                           style="flex: 1; padding: 10px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px;">
                    <select id="height_unit"
                            name="height_unit"
                            style="padding: 10px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px;">
                        <option value="in" {% if vital.height_unit == 'in' %}selected{% endif %}>inches</option>
                        <option value="cm" {% if vital.height_unit == 'cm' %}selected{% endif %}>cm</option>
                    </select>
                </div>
            </div>

        </div>

        <!-- Notes -->
        <div class="form-row" style="margin-top: 20px;">
            <label for="notes" style="display: block; font-size: 13px; font-weight: 600; margin-bottom: 5px;">
                üìù Notes (Optional)
            </label>
            <textarea id="notes"
                      name="notes"
                      rows="4"
                      placeholder="Additional observations or comments about the patient's condition..."
                      style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px; font-family: inherit;">{{ vital.notes|default:'' }}</textarea>
        </div>

        <!-- Information Notice -->
        <div style="background: #fff3cd; border-left: 4px solid #ffc107; padding: 15px; margin: 20px 0; border-radius: 5px;">
            <div style="font-size: 13px; color: #856404;">
                <strong>‚ÑπÔ∏è Important:</strong> You are editing a <strong>Manual Entry</strong> vital sign record.
                Changes will be saved with your name as the editor.
            </div>
        </div>

        <!-- Form Actions -->
        <div style="display: flex; gap: 15px; margin-top: 25px;">
            <button type="submit"
                    style="flex: 1; padding: 12px 24px; background: #4caf50; color: white; border: none; border-radius: 4px; font-size: 14px; font-weight: 600; cursor: pointer;">
                ‚úì Update Vital Signs
            </button>
            <a href="{% url 'nurse_vitals_list' %}"
               style="flex: 1; padding: 12px 24px; background: #f5f5f5; color: #333; border: 1px solid #ddd; border-radius: 4px; font-size: 14px; font-weight: 600; text-align: center; text-decoration: none; display: block;">
                Cancel
            </a>
        </div>
    </form>
</div>

<script>
// Auto-calculate and display BMI if weight and height are provided
document.addEventListener('DOMContentLoaded', function() {
    const weightInput = document.getElementById('weight_value');
    const weightUnit = document.getElementById('weight_unit');
    const heightInput = document.getElementById('height_value');
    const heightUnit = document.getElementById('height_unit');

    function calculateBMI() {
        const weight = parseFloat(weightInput.value);
        const height = parseFloat(heightInput.value);

        if (weight && height) {
            let weightKg = weight;
            let heightM = height;

            // Convert to metric if needed
            if (weightUnit.value === 'lbs') {
                weightKg = weight * 0.453592;
            }
            if (heightUnit.value === 'in') {
                heightM = height * 0.0254;
            } else {
                heightM = height / 100;
            }

            const bmi = (weightKg / (heightM * heightM)).toFixed(1);

            // Display BMI hint
            let bmiCategory = '';
            if (bmi < 18.5) bmiCategory = 'Underweight';
            else if (bmi < 25) bmiCategory = 'Normal';
            else if (bmi < 30) bmiCategory = 'Overweight';
            else bmiCategory = 'Obese';

            console.log(`BMI: ${bmi} (${bmiCategory})`);
        }
    }

    weightInput.addEventListener('input', calculateBMI);
    weightUnit.addEventListener('change', calculateBMI);
    heightInput.addEventListener('input', calculateBMI);
    heightUnit.addEventListener('change', calculateBMI);
});
</script>
{% endblock %}

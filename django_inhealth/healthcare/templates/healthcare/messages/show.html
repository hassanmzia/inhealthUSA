{% extends 'healthcare/base.html' %}

{% block title %}View Message - InHealth EHR{% endblock %}

{% block content %}
<div class="breadcrumbs">
    <a href="{% url 'index' %}">Home</a> &rsaquo;
    {% if request.user.profile.role == 'doctor' %}
        <a href="{% url 'doctor_inbox' %}">Inbox</a>
    {% elif request.user.profile.role == 'patient' %}
        <a href="{% url 'patient_inbox' %}">Inbox</a>
    {% else %}
        <a href="{% url 'message_inbox' %}">Inbox</a>
    {% endif %}
    &rsaquo; View Message
</div>

<div class="module">
    <h1>{{ message.subject }}</h1>

    <div style="margin: 20px 0; padding: 15px; background: #f0f0f0; border-left: 4px solid #417690;">
        <p style="margin: 5px 0;"><strong>From:</strong> {{ message.sender.get_full_name }}</p>
        <p style="margin: 5px 0;"><strong>To:</strong> {{ message.recipient.get_full_name }}</p>
        <p style="margin: 5px 0;"><strong>Date:</strong> {{ message.created_at|date:"M d, Y h:i A" }}</p>
        {% if message.is_read and message.read_at %}
        <p style="margin: 5px 0; color: #28a745;"><strong>âœ“ Read:</strong> {{ message.read_at|date:"M d, Y h:i A" }}</p>
        {% endif %}
    </div>

    <!-- Parent Message (if this is a reply) -->
    {% if message.parent_message %}
    <div style="margin: 20px 0; padding: 15px; background: #f9f9f9; border: 1px solid #ddd;">
        <h3 style="margin-top: 0; color: #666;">In reply to:</h3>
        <p style="margin: 5px 0;"><strong>From:</strong> {{ message.parent_message.sender.get_full_name }}</p>
        <p style="margin: 5px 0;"><strong>Subject:</strong> {{ message.parent_message.subject }}</p>
        <p style="margin: 5px 0;"><strong>Date:</strong> {{ message.parent_message.created_at|date:"M d, Y h:i A" }}</p>
        <hr style="margin: 10px 0; border: none; border-top: 1px solid #ddd;">
        <div style="white-space: pre-wrap; color: #666;">{{ message.parent_message.body }}</div>
    </div>
    {% endif %}

    <!-- Message Body -->
    <div style="margin: 20px 0; padding: 20px; background: white; border: 1px solid #ddd; min-height: 200px;">
        <h2 style="margin-top: 0;">Message:</h2>
        <div style="white-space: pre-wrap; line-height: 1.6;">{{ message.body }}</div>
    </div>

    <!-- Replies -->
    {% if replies %}
    <div style="margin: 30px 0;">
        <h2>Replies ({{ replies|length }})</h2>
        {% for reply in replies %}
        <div style="margin: 15px 0 15px 30px; padding: 15px; background: #f5f5f5; border-left: 3px solid #447e9b;">
            <p style="margin: 5px 0; font-size: 12px; color: #666;">
                <strong>{{ reply.sender.get_full_name }}</strong> - {{ reply.created_at|date:"M d, Y h:i A" }}
            </p>
            <div style="margin-top: 10px; white-space: pre-wrap;">{{ reply.body }}</div>
        </div>
        {% endfor %}
    </div>
    {% endif %}

    <!-- Action Buttons -->
    <div style="margin: 20px 0; padding: 15px 0; border-top: 1px solid #e8e8e8;">
        {% if request.user.profile.role == 'doctor' %}
            <a href="{% url 'doctor_compose_message' %}?reply_to={{ message.message_id }}" class="button" style="margin-right: 10px;">Reply to Message</a>
            <a href="{% url 'doctor_inbox' %}" class="button">Back to Inbox</a>
        {% elif request.user.profile.role == 'patient' %}
            <a href="{% url 'patient_compose_message' %}?reply_to={{ message.message_id }}" class="button" style="margin-right: 10px;">Reply to Message</a>
            <a href="{% url 'patient_inbox' %}" class="button">Back to Inbox</a>
        {% else %}
            <a href="{% url 'message_compose' %}?reply_to={{ message.message_id }}" class="button" style="margin-right: 10px;">Reply to Message</a>
            <a href="{% url 'message_inbox' %}" class="button">Back to Inbox</a>
        {% endif %}

        {% if message.sender == request.user %}
        <form method="POST" action="{% url 'message_delete' message.message_id %}" style="display: inline;" onsubmit="return confirm('Are you sure you want to delete this message?');">
            {% csrf_token %}
            <button type="submit" style="background: #ba2121; color: white; padding: 10px 15px; border: none; cursor: pointer; border-radius: 4px;">Delete Message</button>
        </form>
        {% endif %}
    </div>
</div>
{% endblock %}

{% extends 'healthcare/base.html' %}

{% block title %}API Key Management - InHealth EHR{% endblock %}

{% block content %}
<div class="breadcrumbs">
    <a href="{% url 'index' %}">Home</a> &rsaquo;
    <a href="{% url 'system_admin_dashboard' %}">System Admin Dashboard</a> &rsaquo;
    API Keys
</div>

<div class="module">
    <h1>üîë REST API Key Management</h1>

    <!-- Statistics Cards -->
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin: 20px 0;">
        <div style="padding: 20px; background: #e7f3ff; border-radius: 5px; border-left: 4px solid #2196F3;">
            <div style="font-size: 28px; font-weight: bold; color: #2196F3;">{{ stats.total_keys }}</div>
            <div style="font-size: 13px; color: #666;">Total API Keys</div>
        </div>
        <div style="padding: 20px; background: #e7ffe7; border-radius: 5px; border-left: 4px solid #4caf50;">
            <div style="font-size: 28px; font-weight: bold; color: #4caf50;">{{ stats.active_keys }}</div>
            <div style="font-size: 13px; color: #666;">Active Keys</div>
        </div>
        <div style="padding: 20px; background: #fff3e7; border-radius: 5px; border-left: 4px solid #ff9800;">
            <div style="font-size: 28px; font-weight: bold; color: #ff9800;">{{ stats.inactive_keys }}</div>
            <div style="font-size: 13px; color: #666;">Inactive Keys</div>
        </div>
        <div style="padding: 20px; background: #ffebee; border-radius: 5px; border-left: 4px solid #f44336;">
            <div style="font-size: 28px; font-weight: bold; color: #f44336;">{{ stats.revoked_keys }}</div>
            <div style="font-size: 13px; color: #666;">Revoked Keys</div>
        </div>
        {% if stats.expired_keys > 0 %}
        <div style="padding: 20px; background: #fff3cd; border-radius: 5px; border-left: 4px solid #ffc107;">
            <div style="font-size: 28px; font-weight: bold; color: #856404;">{{ stats.expired_keys }}</div>
            <div style="font-size: 13px; color: #666;">Expired Keys</div>
        </div>
        {% endif %}
    </div>

    <!-- Search and Filter Bar -->
    <div style="display: flex; gap: 10px; margin: 20px 0; flex-wrap: wrap;">
        <form method="get" style="display: flex; gap: 10px; flex: 1;">
            <input type="text" name="search" placeholder="Search by name, description, or key..." value="{{ search_query }}" style="flex: 1; padding: 10px; border: 1px solid #ddd; border-radius: 4px;">
            <select name="status" style="padding: 10px; border: 1px solid #ddd; border-radius: 4px;">
                <option value="">All Statuses</option>
                <option value="active" {% if status_filter == 'active' %}selected{% endif %}>Active</option>
                <option value="inactive" {% if status_filter == 'inactive' %}selected{% endif %}>Inactive</option>
                <option value="revoked" {% if status_filter == 'revoked' %}selected{% endif %}>Revoked</option>
            </select>
            <button type="submit" style="padding: 10px 20px; background: #667eea; color: white; border: none; border-radius: 4px; cursor: pointer;">
                üîç Search
            </button>
            {% if search_query or status_filter %}
            <a href="{% url 'api_key_list' %}" style="padding: 10px 20px; background: #6c757d; color: white; text-decoration: none; border-radius: 4px; display: inline-block;">
                Clear
            </a>
            {% endif %}
        </form>
        <a href="{% url 'api_key_create' %}" style="padding: 10px 20px; background: #28a745; color: white; text-decoration: none; border-radius: 4px; display: inline-block;">
            ‚ûï Create New API Key
        </a>
    </div>

    <!-- API Keys Table -->
    <table style="width: 100%; border-collapse: collapse; margin-top: 20px;">
        <thead>
            <tr style="background: #f0f0f0;">
                <th style="padding: 12px; text-align: left; border-bottom: 2px solid #ddd;">Name</th>
                <th style="padding: 12px; text-align: left; border-bottom: 2px solid #ddd;">API Key</th>
                <th style="padding: 12px; text-align: left; border-bottom: 2px solid #ddd;">Status</th>
                <th style="padding: 12px; text-align: left; border-bottom: 2px solid #ddd;">Permissions</th>
                <th style="padding: 12px; text-align: left; border-bottom: 2px solid #ddd;">Usage</th>
                <th style="padding: 12px; text-align: left; border-bottom: 2px solid #ddd;">Created</th>
                <th style="padding: 12px; text-align: center; border-bottom: 2px solid #ddd;">Actions</th>
            </tr>
        </thead>
        <tbody>
            {% for key in api_keys %}
            <tr style="border-bottom: 1px solid #e8e8e8;">
                <td style="padding: 12px;">
                    <strong>{{ key.name }}</strong>
                    {% if key.description %}
                    <br><span style="font-size: 12px; color: #666;">{{ key.description|truncatewords:10 }}</span>
                    {% endif %}
                </td>
                <td style="padding: 12px; font-family: monospace; font-size: 12px;">
                    {{ key.key|slice:":16" }}...
                </td>
                <td style="padding: 12px;">
                    {% if key.status == 'active' %}
                        {% if key.is_expired %}
                            <span style="padding: 4px 8px; background: #ffc107; color: #856404; border-radius: 3px; font-size: 11px; font-weight: bold;">‚ö† EXPIRED</span>
                        {% else %}
                            <span style="padding: 4px 8px; background: #d4edda; color: #155724; border-radius: 3px; font-size: 11px; font-weight: bold;">‚úì ACTIVE</span>
                        {% endif %}
                    {% elif key.status == 'inactive' %}
                        <span style="padding: 4px 8px; background: #f8d7da; color: #721c24; border-radius: 3px; font-size: 11px; font-weight: bold;">‚äó INACTIVE</span>
                    {% else %}
                        <span style="padding: 4px 8px; background: #f8d7da; color: #721c24; border-radius: 3px; font-size: 11px; font-weight: bold;">‚úñ REVOKED</span>
                    {% endif %}
                </td>
                <td style="padding: 12px; font-size: 12px;">
                    {% if key.permissions %}
                        {{ key.permissions|join:", " }}
                    {% else %}
                        <span style="color: #999;">None</span>
                    {% endif %}
                </td>
                <td style="padding: 12px; font-size: 13px;">
                    <strong>{{ key.usage_count }}</strong> calls
                    {% if key.last_used_at %}
                    <br><span style="font-size: 11px; color: #666;">Last: {{ key.last_used_at|date:"M d, Y H:i" }}</span>
                    {% endif %}
                </td>
                <td style="padding: 12px; font-size: 12px; color: #666;">
                    {{ key.created_at|date:"M d, Y" }}
                    {% if key.created_by %}
                    <br>by {{ key.created_by.get_full_name|default:key.created_by.username }}
                    {% endif %}
                </td>
                <td style="padding: 12px; text-align: center;">
                    <div style="display: flex; gap: 5px; justify-content: center;">
                        <a href="{% url 'api_key_detail' key.api_key_id %}" style="padding: 5px 10px; background: #17a2b8; color: white; text-decoration: none; border-radius: 3px; font-size: 12px;">
                            View
                        </a>
                        <a href="{% url 'api_key_edit' key.api_key_id %}" style="padding: 5px 10px; background: #ffc107; color: #333; text-decoration: none; border-radius: 3px; font-size: 12px;">
                            Edit
                        </a>
                    </div>
                </td>
            </tr>
            {% empty %}
            <tr>
                <td colspan="7" style="padding: 40px; text-align: center; color: #999;">
                    <div style="font-size: 48px; margin-bottom: 10px;">üîë</div>
                    <div style="font-size: 16px;">No API keys found</div>
                    <div style="margin-top: 15px;">
                        <a href="{% url 'api_key_create' %}" style="padding: 10px 20px; background: #28a745; color: white; text-decoration: none; border-radius: 4px; display: inline-block;">
                            Create Your First API Key
                        </a>
                    </div>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>
{% endblock %}

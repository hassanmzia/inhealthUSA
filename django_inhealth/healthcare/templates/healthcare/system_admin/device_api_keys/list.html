{% extends 'healthcare/base.html' %}

{% block title %}Device API Key Management - InHealth EHR{% endblock %}

{% block content %}
<div class="breadcrumbs">
    <a href="{% url 'index' %}">Home</a> &rsaquo;
    <a href="{% url 'system_admin_dashboard' %}">System Admin Dashboard</a> &rsaquo;
    Device API Keys
</div>

<div class="module">
    <h1>üì± IoT Device API Key Management</h1>

    <!-- Statistics Cards -->
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin: 20px 0;">
        <div style="padding: 20px; background: #e7f3ff; border-radius: 5px; border-left: 4px solid #2196F3;">
            <div style="font-size: 28px; font-weight: bold; color: #2196F3;">{{ stats.total_keys }}</div>
            <div style="font-size: 13px; color: #666;">Total Device Keys</div>
        </div>
        <div style="padding: 20px; background: #e7ffe7; border-radius: 5px; border-left: 4px solid #4caf50;">
            <div style="font-size: 28px; font-weight: bold; color: #4caf50;">{{ stats.active_keys }}</div>
            <div style="font-size: 13px; color: #666;">Active Keys</div>
        </div>
        <div style="padding: 20px; background: #fff3e7; border-radius: 5px; border-left: 4px solid #ff9800;">
            <div style="font-size: 28px; font-weight: bold; color: #ff9800;">{{ stats.inactive_keys }}</div>
            <div style="font-size: 13px; color: #666;">Inactive Keys</div>
        </div>
        <div style="padding: 20px; background: #ffebee; border-radius: 5px; border-left: 4px solid #f44336;">
            <div style="font-size: 28px; font-weight: bold; color: #f44336;">{{ stats.expired_keys }}</div>
            <div style="font-size: 13px; color: #666;">Expired Keys</div>
        </div>
    </div>

    <!-- Search and Filter Bar -->
    <div style="display: flex; gap: 10px; margin: 20px 0; flex-wrap: wrap;">
        <form method="get" style="display: flex; gap: 10px; flex: 1;">
            <input type="text" name="search" placeholder="Search by key name, device, or patient..." value="{{ search_query }}" style="flex: 1; padding: 10px; border: 1px solid #ddd; border-radius: 4px;">
            <select name="status" style="padding: 10px; border: 1px solid #ddd; border-radius: 4px;">
                <option value="">All Statuses</option>
                <option value="active" {% if status_filter == 'active' %}selected{% endif %}>Active</option>
                <option value="inactive" {% if status_filter == 'inactive' %}selected{% endif %}>Inactive</option>
                <option value="expired" {% if status_filter == 'expired' %}selected{% endif %}>Expired</option>
            </select>
            <select name="device" style="padding: 10px; border: 1px solid #ddd; border-radius: 4px;">
                <option value="">All Devices</option>
                {% for device in devices %}
                <option value="{{ device.device_id }}" {% if device_filter == device.device_id|stringformat:"s" %}selected{% endif %}>
                    {{ device.device_name }}
                </option>
                {% endfor %}
            </select>
            <button type="submit" style="padding: 10px 20px; background: #667eea; color: white; border: none; border-radius: 4px; cursor: pointer;">
                üîç Search
            </button>
            {% if search_query or status_filter or device_filter %}
            <a href="{% url 'device_api_key_list' %}" style="padding: 10px 20px; background: #6c757d; color: white; text-decoration: none; border-radius: 4px; display: inline-block;">
                Clear
            </a>
            {% endif %}
        </form>
        <a href="{% url 'device_api_key_create' %}" style="padding: 10px 20px; background: #28a745; color: white; text-decoration: none; border-radius: 4px; display: inline-block;">
            ‚ûï Create New Device API Key
        </a>
    </div>

    <!-- Device API Keys Table -->
    <table style="width: 100%; border-collapse: collapse; margin-top: 20px;">
        <thead>
            <tr style="background: #f0f0f0;">
                <th style="padding: 12px; text-align: left; border-bottom: 2px solid #ddd;">Key Name</th>
                <th style="padding: 12px; text-align: left; border-bottom: 2px solid #ddd;">Device</th>
                <th style="padding: 12px; text-align: left; border-bottom: 2px solid #ddd;">Patient</th>
                <th style="padding: 12px; text-align: left; border-bottom: 2px solid #ddd;">Key Prefix</th>
                <th style="padding: 12px; text-align: left; border-bottom: 2px solid #ddd;">Status</th>
                <th style="padding: 12px; text-align: left; border-bottom: 2px solid #ddd;">Permissions</th>
                <th style="padding: 12px; text-align: left; border-bottom: 2px solid #ddd;">Created</th>
                <th style="padding: 12px; text-align: center; border-bottom: 2px solid #ddd;">Actions</th>
            </tr>
        </thead>
        <tbody>
            {% for key in api_keys %}
            <tr style="border-bottom: 1px solid #e8e8e8;">
                <td style="padding: 12px;">
                    <strong>{{ key.key_name }}</strong>
                    {% if key.notes %}
                    <br><span style="font-size: 12px; color: #666;">{{ key.notes|truncatewords:8 }}</span>
                    {% endif %}
                </td>
                <td style="padding: 12px;">
                    <strong>{{ key.device.device_name }}</strong>
                    <br><span style="font-size: 11px; color: #999; font-family: monospace;">{{ key.device.device_unique_id }}</span>
                </td>
                <td style="padding: 12px;">
                    {% if key.device.patient %}
                        {{ key.device.patient.get_full_name }}
                        <br><span style="font-size: 11px; color: #999;">MRN: {{ key.device.patient.mrn }}</span>
                    {% else %}
                        <span style="color: #999;">No patient</span>
                    {% endif %}
                </td>
                <td style="padding: 12px; font-family: monospace; font-size: 12px; color: #667eea;">
                    {{ key.key_prefix }}...
                </td>
                <td style="padding: 12px;">
                    {% if key.is_active %}
                        {% if key.expires_at and key.expires_at <= now %}
                            <span style="padding: 4px 8px; background: #ffc107; color: #856404; border-radius: 3px; font-size: 11px; font-weight: bold;">‚ö† EXPIRED</span>
                        {% else %}
                            <span style="padding: 4px 8px; background: #d4edda; color: #155724; border-radius: 3px; font-size: 11px; font-weight: bold;">‚úì ACTIVE</span>
                        {% endif %}
                    {% else %}
                        <span style="padding: 4px 8px; background: #f8d7da; color: #721c24; border-radius: 3px; font-size: 11px; font-weight: bold;">‚äó INACTIVE</span>
                    {% endif %}
                </td>
                <td style="padding: 12px; font-size: 12px;">
                    {% if key.can_write_vitals %}
                        <span style="padding: 2px 6px; background: #e7f3ff; color: #2196F3; border-radius: 3px; font-size: 10px;">üìä Write</span>
                    {% endif %}
                    {% if key.can_read_patient %}
                        <span style="padding: 2px 6px; background: #e7ffe7; color: #4caf50; border-radius: 3px; font-size: 10px;">üë§ Read</span>
                    {% endif %}
                    {% if not key.can_write_vitals and not key.can_read_patient %}
                        <span style="color: #999;">None</span>
                    {% endif %}
                </td>
                <td style="padding: 12px; font-size: 12px; color: #666;">
                    {{ key.created_at|date:"M d, Y" }}
                    {% if key.last_used_at %}
                    <br><span style="font-size: 11px; color: #999;">Used: {{ key.last_used_at|date:"M d" }}</span>
                    {% endif %}
                </td>
                <td style="padding: 12px; text-align: center;">
                    <div style="display: flex; gap: 5px; justify-content: center;">
                        <a href="{% url 'device_api_key_detail' key.id %}" style="padding: 5px 10px; background: #17a2b8; color: white; text-decoration: none; border-radius: 3px; font-size: 12px;">
                            View
                        </a>
                        <a href="{% url 'device_api_key_edit' key.id %}" style="padding: 5px 10px; background: #ffc107; color: #333; text-decoration: none; border-radius: 3px; font-size: 12px;">
                            Edit
                        </a>
                    </div>
                </td>
            </tr>
            {% empty %}
            <tr>
                <td colspan="8" style="padding: 40px; text-align: center; color: #999;">
                    <div style="font-size: 48px; margin-bottom: 10px;">üì±</div>
                    <div style="font-size: 16px;">No device API keys found</div>
                    <div style="margin-top: 15px;">
                        <a href="{% url 'device_api_key_create' %}" style="padding: 10px 20px; background: #28a745; color: white; text-decoration: none; border-radius: 4px; display: inline-block;">
                            Create Your First Device API Key
                        </a>
                    </div>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>
{% endblock %}

{% extends 'healthcare/base.html' %}

{% block title %}All IoT Devices - InHealth EHR{% endblock %}

{% block content %}
<div class="breadcrumbs">
    <a href="{% url 'index' %}">Home</a> &rsaquo; All IoT Devices
</div>

<div class="module">
    <h1>All IoT Medical Devices</h1>
    <p style="color: #666; margin-top: 10px;">System-wide IoT device management</p>

    <!-- Search Form -->
    <div class="search-form">
        <form method="get">
            <input type="text" name="search" placeholder="Search by device name, type, ID, or patient..." value="{{ search }}" style="width: 400px; padding: 8px; border: 1px solid #ccc; border-radius: 4px;">
            <button type="submit" class="button" style="background: #417690; color: white; padding: 8px 20px; border: none; border-radius: 4px; cursor: pointer;">Search</button>
            {% if search %}
                <a href="{% url 'device_list' %}" class="button" style="background: #666; color: white; padding: 8px 20px; text-decoration: none; border-radius: 4px; margin-left: 5px;">Clear</a>
            {% endif %}
        </form>
    </div>

    <!-- Device Count -->
    <div style="background: #e7f3ff; padding: 15px; border-radius: 5px; margin: 20px 0; border-left: 4px solid #417690;">
        <strong>Total Devices:</strong> {{ devices|length }}
        {% if search %}
            (filtered by "{{ search }}")
        {% endif %}
    </div>

    <!-- Devices Grid -->
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: 20px; margin-top: 20px;">
        {% for device in devices %}
            <div style="background: white; border: 1px solid #ccc; border-radius: 5px; padding: 20px; transition: box-shadow 0.2s;">
                <!-- Device Header -->
                <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 15px; border-bottom: 2px solid #e8e8e8; padding-bottom: 15px;">
                    <div style="flex: 1;">
                        <h3 style="margin: 0 0 5px 0; color: #333;">{{ device.device_name }}</h3>
                        <p style="margin: 0; color: #666; font-size: 14px;">{{ device.device_type }}</p>
                    </div>
                    <div>
                        {% if device.status == 'Active' %}
                            <span style="display: inline-flex; align-items: center; padding: 5px 12px; border-radius: 15px; font-size: 12px; font-weight: bold; background: #dfd; color: #2e7d32;">
                                <span style="display: inline-block; width: 8px; height: 8px; background: #4caf50; border-radius: 50%; margin-right: 5px;"></span>
                                Active
                            </span>
                        {% elif device.status == 'Inactive' %}
                            <span style="display: inline-flex; align-items: center; padding: 5px 12px; border-radius: 15px; font-size: 12px; font-weight: bold; background: #e8e8e8; color: #666;">
                                Inactive
                            </span>
                        {% elif device.status == 'Maintenance' %}
                            <span style="display: inline-flex; align-items: center; padding: 5px 12px; border-radius: 15px; font-size: 12px; font-weight: bold; background: #ffc; color: #856404;">
                                Maintenance
                            </span>
                        {% else %}
                            <span style="display: inline-flex; align-items: center; padding: 5px 12px; border-radius: 15px; font-size: 12px; font-weight: bold; background: #ffefef; color: #ba2121;">
                                Retired
                            </span>
                        {% endif %}
                    </div>
                </div>

                <!-- Patient Info -->
                <div style="margin-bottom: 15px; background: #f8f8f8; padding: 10px; border-radius: 4px;">
                    <p style="margin: 0 0 3px 0; font-size: 11px; color: #999; text-transform: uppercase;">Patient</p>
                    {% if device.patient %}
                        <p style="margin: 0; font-size: 14px; color: #333;">
                            <a href="{% url 'patient_detail' device.patient.patient_id %}" style="color: #447e9b; text-decoration: none;">{{ device.patient.full_name }}</a>
                        </p>
                    {% else %}
                        <p style="margin: 0; font-size: 14px; color: #999;">Not assigned</p>
                    {% endif %}
                </div>

                <!-- Device ID -->
                <div style="margin-bottom: 15px;">
                    <p style="margin: 0 0 3px 0; font-size: 11px; color: #999; text-transform: uppercase;">Device ID</p>
                    <p style="margin: 0; font-family: monospace; font-size: 13px; color: #333;">{{ device.device_unique_id }}</p>
                </div>

                <!-- Battery Level -->
                {% if device.battery_level is not None %}
                    <div style="margin-bottom: 15px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px;">
                            <p style="margin: 0; font-size: 12px; color: #666; font-weight: bold;">Battery Level</p>
                            <p style="margin: 0; font-size: 12px; font-weight: bold; {% if device.battery_color == 'green' %}color: #4caf50{% elif device.battery_color == 'yellow' %}color: #ff9800{% else %}color: #f44336{% endif %};">
                                {{ device.battery_level }}%
                            </p>
                        </div>
                        <div style="width: 100%; height: 8px; background: #e8e8e8; border-radius: 4px; overflow: hidden;">
                            <div style="height: 100%; {% if device.battery_color == 'green' %}background: #4caf50{% elif device.battery_color == 'yellow' %}background: #ff9800{% else %}background: #f44336{% endif %}; width: {{ device.battery_level }}%; border-radius: 4px;"></div>
                        </div>
                    </div>
                {% endif %}

                <!-- Capabilities -->
                {% if device.capabilities_list %}
                    <div style="margin-bottom: 15px;">
                        <p style="margin: 0 0 8px 0; font-size: 12px; color: #666; font-weight: bold;">Capabilities</p>
                        <div style="display: flex; flex-wrap: wrap; gap: 5px;">
                            {% for capability in device.capabilities_list %}
                                <span style="display: inline-block; padding: 4px 8px; font-size: 11px; font-weight: 500; background: #e7f3ff; color: #0c5282; border: 1px solid #b3d9ff; border-radius: 3px;">
                                    {{ capability }}
                                </span>
                            {% endfor %}
                        </div>
                    </div>
                {% endif %}

                <!-- Last Sync -->
                {% if device.last_sync %}
                    <div style="margin-bottom: 15px;">
                        <p style="margin: 0; font-size: 12px; color: #999;">
                            Last synced: <span style="font-weight: 500; color: #666;">{{ device.last_sync|timesince }} ago</span>
                        </p>
                    </div>
                {% endif %}

                <!-- Actions -->
                <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid #e8e8e8;">
                    {% if device.patient %}
                        <a href="{% url 'patient_device_detail' device.patient.patient_id device.device_id %}" style="display: inline-flex; align-items: center; font-size: 14px; font-weight: 500; color: #447e9b; text-decoration: none;">
                            View Details →
                        </a>
                    {% else %}
                        <span style="color: #999; font-size: 14px;">No actions available</span>
                    {% endif %}
                </div>
            </div>
        {% empty %}
            <div style="grid-column: 1 / -1;">
                <div style="text-align: center; padding: 60px 20px; background: #f8f8f8; border-radius: 8px;">
                    <div style="display: inline-flex; align-items: center; justify-content: center; width: 64px; height: 64px; background: #e8e8e8; border-radius: 50%; margin-bottom: 20px;">
                        <span style="font-size: 32px;">⌚</span>
                    </div>
                    <h3 style="margin: 0 0 10px 0; color: #333; font-size: 18px;">No devices found</h3>
                    <p style="margin: 0; color: #666;">
                        {% if search %}
                            No devices match your search criteria.
                        {% else %}
                            No IoT medical devices are registered in the system.
                        {% endif %}
                    </p>
                </div>
            </div>
        {% endfor %}
    </div>
</div>
{% endblock %}
